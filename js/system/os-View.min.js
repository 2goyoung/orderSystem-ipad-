orderSystem.View.login=Backbone.View.extend({el:"#login",events:{submit:"login"},initialize:function(){_.bindAll(this,"login","verify");this.model=new orderSystem.Model.login},login:function(n){$("input:focus").blur();n.preventDefault();var t=$.trim($("#u-name").val()),i=hex_md5($.trim($("#u-pw").val()));this.model.save({username:t,password:i},{success:this.verify,error:this.fetchError})},verify:function(n,t){n.clear();t.state=="1"?this.loginSuccess():this.loginFail(t.message)},loginSuccess:function(){$("#u-pw").val("");orderSystem.pages.channel()},loginFail:function(n){ospage.loading.hide();n!==undefined&&orderSystem.alert("登录失败 "+n)},fetchError:function(){orderSystem.alert("登录请求出错，请重试或刷新页面")}});orderSystem.View.logout=Backbone.View.extend({el:"body",events:{"tap .btn-logout":"logout"},initialize:function(){_.bindAll(this,"verify","logout","logoutSuccess","logoutFail");this.Model=new orderSystem.Model.logout},logout:function(){return ospage.setLoadingText("帐号注销中...").show(),this.Model.fetch({success:this.verify}),!1},verify:function(n,t){n.clear();t.state=="1"?this.logoutSuccess():this.logoutFail(t.message)},logoutSuccess:function(){ospage.loading.hide();var n=ospage.getCurrentId();$("#os-login").show();ospage.closePage({pageId:n,animateClass:"pop out reverse",remove:!0})},logoutFail:function(n){ospage.loading.hide();orderSystem.alert(n)}});orderSystem.View.teaListItem=Backbone.View.extend({tagName:"li",initialize:function(){_.bindAll(this,"teaAdd","teaMinus","selectNum","updataUI");this.model.on("change",this.updataUI);return this},events:{"tap .add":"teaAdd","tap .minus":"teaMinus","change select":"selectNum"},teaAdd:function(){var i=this.model.attributes.salePrices[0].price,n=this.model.attributes.ordNum===undefined?1:this.model.attributes.ordNum+1,t;n>this.$el.find("select option").length-1&&(t=this.$el.find("select"),t.find("option").last().clone().appendTo(t).html(n));this.model.set({ordNum:n})},teaMinus:function(){var t=this.model.attributes.salePrices[0].price,n;if(this.model.attributes.ordNum===undefined||this.model.attributes.ordNum==0)return!1;n=this.model.attributes.ordNum-1;this.model.set({ordNum:n})},selectNum:function(){var n=parseInt(this.$el.find("select").val());this.model.set({ordNum:n})},updataUI:function(){this.$el.find("select option").eq(this.model.attributes.ordNum)[0].selected=!0;$(".c-panel .bg-layer").addClass("flash");var n=orderSystem.datas.order.teaList.calculate(),t=parsePrice(n.totalPrice);$(".c-panel .teas i").html('<span class="c">'+n.totalNum+'<\/span>/<span class="max">'+orderSystem.datas.order.dinNum+"<\/span>");$(".c-panel .count i").html(t);orderSystem.datas.order.perNum=n.totalNum}});orderSystem.View.teaList=Backbone.View.extend({el:".teas-list",initialize:function(){var n=this;_.bindAll(this,"render","renderItem");this.template=_.template($("#template-tea-list").html())},render:function(){for(var n=0;n<this.collection.models.length;n++)this.renderItem(this.collection.models[n]);return this},renderItem:function(n){var t=new orderSystem.View.teaListItem({model:n});this.$el.append(t.$el.wrapInner(this.template(t.model.toJSON())))}});orderSystem.View.orderPanel=Backbone.View.extend({el:".c-panel",events:{"tap .btn-ok":"createOrder","tap .btn-cancel":"closePanel"},initialize:function(){_.bindAll(this,"reset","submitOrder","createOrder","switchState","orderSuccess","submitSuccess");this.$panel=$(this.el);this.$teas=this.$panel.find(".teas i");this.$count=this.$panel.find(".count i");this.$tNum=this.$panel.find(".table-num")},reset:function(n,t,r){orderSystem.datas.order.teaList.reset();orderSystem.teaList.collection.each(function(n){n.set({ordNum:0},{silent:!0})});this.$tNum.html(n);this.$count.html("0.00");this.$teas.html('<span class="c">0<\/span>/<span class="max">'+t+"<\/span>");var u="";for(i=0;i<=t;i++)u+="<option>"+i+"<\/option>";this.$el.find("select").each(function(){$(this).html(u)});r!==undefined&&r()},showPanel:function(){$(".c-panel").addClass("in")},closePanel:function(){$(".opening").removeClass("opening");$(".c-panel").removeClass("in")},createOrder:function(){ospage.setLoadingText("正在创建订单...").show();var n=new orderSystem.Model.createOrder;n.fetch({data:{dinCode:orderSystem.datas.order.dinCode},success:this.switchState,error:this.fetchError})},submitOrder:function(){var n=orderSystem.datas.order.teaList.calculate().totalNum;this.model=new orderSystem.Model.orderTeaList({ordId:orderSystem.datas.order.id,cusNum:n,dishInfo:orderSystem.datas.order.teaList.toJsonList()});this.model.save(null,{success:this.submitSuccess,error:this.fetchError})},switchState:function(n,t){switch(t.state){case"0":orderSystem.datas.order.id===undefined||orderSystem.datas.order.id==""?this.createError(t.message):this.submitOrder();break;case"1":orderSystem.datas.order.id=t.ordId;this.submitOrder()}},createError:function(n){ospage.loading.hide();setTimeout(function(){orderSystem.alert(n)},200)},submitSuccess:function(n,t){t.state=="1"?this.orderSuccess():this.orderError()},orderSuccess:function(){orderSystem.datas.order.teaList.each(function(n){var t=n.attributes.ordNum;n.set({state:"2",total:t})});orderSystem.pages.guide()},orderError:function(){ospage.loading.hide();setTimeout(function(){orderSystem.alert("茶品下单出错，请重试")},400)},fetchError:function(){ospage.loading.hide();setTimeout(function(){orderSystem.alert("请求出错，请重试")},400)}});orderSystem.View.areaCode=Backbone.View.extend({el:".select-area",events:{"tap li":"changeArea"},initialize:function(){_.bindAll(this,"render","fetchError");this.template=_.template($("#template-area-code").html());this.collection=new orderSystem.Collection.areaCode;this.collection.fetch({success:this.render,error:this.fetchError});$(".table-content").livequery("webkitAnimationEnd",function(){$(this).removeClass("in out flow reverse")})},render:function(n,t){var i=this,r={datas:t};this.$el.html(this.template(r));setTimeout(function(){$.each(i.$el.find("li"),function(n){var t=.1*n;$(this).attr("style","-webkit-transition-delay:"+t+"s;").addClass("t")})},100);this.tableList=new orderSystem.View.tableList({areaCode:t})},fetchError:function(){orderSystem.alert("餐桌区域获取失败")},changeArea:function(n){var r=this,t=$(n.target);if(t.hasClass("active"))return!1;var i=t.attr("areacode"),u=$(".select-area .active").attr("areacode"),f=t.index(),e=$(".select-area .active").index(),o=f-e;if($(".select-area .active").removeClass("active"),t.addClass("active"),o>0)$('.table-content[area-code="'+u+'"]').addClass("flow out").one("webkitAnimationEnd",function(){var n=$('.table-content[area-code="'+i+'"]');n.addClass("active flow in").one("webkitAnimationEnd",function(){n.attr("has-data")!="true"&&r.tableList.gettableList(i)});$(this).removeClass("active")});else $('.table-content[area-code="'+u+'"]').addClass("flow out reverse").one("webkitAnimationEnd",function(){var n=$('.table-content[area-code="'+i+'"]');n.addClass("active flow in reverse").one("webkitAnimationEnd",function(){n.attr("has-data")!="true"&&r.tableList.gettableList(i)});$(this).removeClass("active")});n.preventDefault()}});orderSystem.View.tableList=Backbone.View.extend({el:".table-content-wrap",count:0,initialize:function(){var i=this,n,t;_.bindAll(this,"render","fetchError","gettableList","timming","updata");this.templateListWrap=_.template($("#template-list-wrap").html());this.templateList=_.template($("#template-table-list").html());$(".table-content-wrap").html(this.templateListWrap({code:this.options.areaCode}));this.collection=new orderSystem.Collection.tableList;n=this.options.areaCode[0].areaCode;t=$('.table-content[area-code="'+n+'"]').addClass("active");this.gettableList(n);$(".c-panel .bg-layer").livequery("webkitAnimationEnd",function(){$(this).removeClass("flash")});$(this.el).on("tap",".t-reserve,.t-free",function(n){n.stopPropagation();orderSystem.datas.order.dinList=new orderSystem.Collection.dinOrder;var t=$(this);if(t.hasClass("opening"))return!1;$(".opening").removeClass("opening");t.addClass("opening");orderSystem.datas.order.dinCode=t.parent().attr("din-code");orderSystem.datas.order.dinNum=t.parent().attr("din-num");orderSystem.orderPanel.reset(orderSystem.datas.order.dinCode,orderSystem.datas.order.dinNum,orderSystem.orderPanel.showPanel)});$(this.el).on("tap",".t-repast",function(){orderSystem.datas.order.dinList=new orderSystem.Collection.dinOrder;var n=$(this).next().text();orderSystem.datas.order.dinCode=$(this).parent().attr("din-code");orderSystem.confirm("餐桌("+n+")已开台，是否查看该餐桌的订单？",{btnOKText:"查看",okCallback:function(){orderSystem.pages.order()}})})},gettableList:function(n){this.areaCode=n;this.collection.fetch({data:{_leq_areaCode:n},success:this.render,error:this.fetchError})},render:function(n,t){var r={tableList:t},i=$('.table-content[area-code="'+this.areaCode+'"]');return i.html(this.templateList(r)),this.timming(),i.find("li[din-code]").addClass("hide-out out").hide(),iscroll.tableList[this.count]=new iScroll(i[0]),tableFilter.sort(sortData.status,sortData.contain),i.attr("has-data","true"),this.count++,this},timming:function(){this.timer={};var n=new Date,t=/\d{1,2}/g,i=n.getHours(),r=n.getMinutes();$(".t-repast .time").each(function(){var f=$(this).attr("start-time"),u=f.match(t),e=parseInt(i-u[0]),n=r-u[1];$(this).html("<span>"+e+":"+(n>9?n:"0"+n)+"<\/span>")});this.timer=setTimeout(this.timming,3e4)},updata:function(){},fetchError:function(){orderSystem.alert("error")}});orderSystem.View.dinCatItem=Backbone.View.extend({tagName:"li",events:{tap:"changeCat"},initialize:function(){_.bindAll(this,"render","changeCat","renderDinList","getDinList","renderDinListItem");this.$dinListPanel=$($("#template-din-list-wrap").html()).appendTo($(".food-content"));this.$el.attr("id","t_"+this.model.attributes.id)},render:function(n,t){var i={dinCat:t};console.log(this.template(i))},changeCat:function(){if(this.$el.hasClass("active"))return!1;var n=this;this.$el.siblings(".active").removeClass("active");this.$el.addClass("active");$(".food-active").removeClass("din-in").addClass("din-out").one("webkitAnimationEnd",function(){$(this).removeClass("food-active din-out")});this.$dinListPanel.removeClass("din-out").addClass("food-active din-in").one("webkitAnimationEnd",function(){if($(this).removeClass("din-in"),$(this).attr("has-data")=="true")return!1;n.getDinList()})},getDinList:function(){var n=new orderSystem.Collection.dinList;n.fetch({data:{_seq_typeId:this.model.id},success:this.renderDinList})},renderDinList:function(n){var u=this.model.id,t,i,r;for(n.each(function(n){orderSystem.datas.dinListLoaded.add(n);n.set({typeId:u},{silent:!0})}),orderSystem.datas.order.dinList.length!=0&&(t=orderSystem.datas.order.dinList.where({typeId:this.model.id}),t.length&&(_.each(t,function(i){if(i.attributes.state!=0){var r=n.findWhere({dishId:i.attributes.dishId});i.attributes.state==1?(r.set({ordNum:parseInt(r.attributes.ordNum,10)+parseInt(i.attributes.ordNum,10)}),typeof i.attributes.temporary!="undefined"&&console.log(t)):r.set({total:parseInt(r.attributes.total,10)+parseInt(i.attributes.total,10)})}}),console.log(n))),this.listHtml=$('<ul class="food-list hide">'),i=0;i<n.models.length;i++)this.renderDinListItem(n.models[i]);r=this.$dinListPanel.find(".food-list .justify-fix");this.$dinListPanel.find(".i-loading").remove();this.listHtml.append(r).one("webkitAnimationEnd",function(){$(this).removeClass("din-show")}).addClass("din-show");this.$dinListPanel.attr("has-data","true").prepend(this.listHtml).find(".food-list").eq(1).remove();iscroll.menu[this.model.attributes.id]=new iScroll(this.$dinListPanel[0])},renderDinListItem:function(n){var t=new orderSystem.View.dinList({model:n});t.$el.wrapInner(t.template(t.model.toJSON())).appendTo(this.listHtml).after("\n")}});orderSystem.View.dinCat=Backbone.View.extend({el:".menu-nav-list",initialize:function(){return _.bindAll(this,"render","renderItem"),this.template=_.template($("#template-din-cat").html()),this},render:function(){for(var n=0;n<this.collection.models.length;n++)this.renderItem(this.collection.models[n]);return this},renderItem:function(n){var t=new orderSystem.View.dinCatItem({model:n});this.$el.append(t.$el.wrapInner(this.template(t.model.toJSON())))}});orderSystem.View.dinList=Backbone.View.extend({tagName:"li",events:{"tap .add":"dinAdd","tap .minus":"dinMinus","change select":"selectNum","click .food-wrap":"showDetail"},initialize:function(){_.bindAll(this,"dinAdd","dinMinus","selectNum","showDetail","updataUI");this.template=_.template($("#template-din-list").html());this.detailTemplate=_.template($("#template-din-detail-item").html());this.model.on("change",this.updataUI)},dinAdd:function(){var n=this.model.attributes.ordNum+1;this.model.set({ordNum:n})},dinMinus:function(){var n=this.model.attributes.ordNum-1;if(n<0)return this.model.attributes.total!=0&&orderSystem.alert("由于此菜品已下单，无法直接删减。你可到订单页进行操作或咨询服务员"),!1;this.model.set({ordNum:n})},selectNum:function(){var n=this.model.attributes.total,t=parseInt(this.$el.find("select").val())-n;this.model.set({ordNum:t})},updataUI:function(){var t,i,r;if($("#menu").length==0)return!1;var u=parseInt(this.model.attributes.ordNum,10),f=parseInt(this.model.attributes.total,10),n=u+f;n==0?this.$el.find(".food-wrap").removeClass("in-order"):this.model.previous("ordNum")==0&&this.model.attributes.total==0&&this.$el.find(".food-wrap").addClass("in-order");this.$el.find(".order-num").html("+<span>"+n+"<\/span>");t="";_.each(_.range(this.model.attributes.total,n>=11?n+1:11),function(i){t+=i==n?"<option selected>"+i+"<\/option>":"<option>"+i+"<\/option>"});this.$el.find("select").html(t);i=orderSystem.datas.order.dinList.calculate();r=parsePrice(i.totalPrice);$("#din-count").html(i.totalNum);$("#din-price").html(r)},showDetail:function(){var n=new orderSystem.View.dinDetail({model:this.model}),t=orderSystem.datas.detialIndex=this.model.collection.indexOf(this.model);n.setslider(t);$(".din-item-detail").addClass("pop in food-active").one("webkitAnimationEnd",function(){$(this).removeClass("pop in");$(this).one("webkitAnimationEnd",function(){$(this).removeClass("pop out food-active")})})}});orderSystem.View.dinDetail=Backbone.View.extend({tagName:"div",events:{"tap .add":"dinAdd","tap .minus":"dinMinus","change select":"selectNum","swipeLeft .img":"swipeLeft","swipeRight .img":"swipeRight"},attributes:{"class":"item"},initialize:function(){_.bindAll(this,"dinAdd","dinMinus","selectNum","updataUI","setslider");var n=this;this.template=_.template($("#template-din-detail-item").html());this.$el.wrapInner(this.template(this.model.toJSON())).appendTo($(".din-item-detail .wrap"));this.model.on("change:ordNum",this.updataUI);loadImg(this.$el.find("img"),function(){})},dinAdd:function(){var n=this.model.attributes.ordNum+1;this.model.set({ordNum:n})},dinMinus:function(){var n=this.model.attributes.ordNum-1;if(n<0)return this.model.attributes.total!=0&&orderSystem.alert("由于此菜品已下单，无法直接删减。你可到订单页进行操作或咨询服务员"),!1;this.model.set({ordNum:n})},selectNum:function(){var n=parseInt(this.$el.find("select").val()-this.model.attributes.total,10);this.model.set({ordNum:n})},updataUI:function(){var t;if($("#menu").length==0)return!1;var i=parseInt(this.model.attributes.ordNum,10),r=parseInt(this.model.attributes.total,10),n=i+r;this.model.previous("ordNum")==0?this.$el.find(".corner").removeClass("hide-item"):n==0&&this.$el.find(".corner").addClass("hide-item");this.$el.find(".order-num").html("<span>"+n+"<\/span>");t="";_.each(_.range(this.model.attributes.total,n>=11?n+1:11),function(i){t+=i==n?"<option selected>"+i+"<\/option>":"<option>"+i+"<\/option>"});this.$el.find("select").html(t)},swipeLeft:function(){var n=this;orderSystem.datas.haSwipe=!0;$(".din-item-detail .wrap").addClass("animate").css({"-webkit-transform":"translate3d(-100%, 0, 0)"}).one("webkitTransitionEnd",function(){if(++orderSystem.datas.detialIndex,$(".din-item-detail .item.prev").remove(),$(".din-item-detail .item").not(".next").addClass("prev"),$(".din-item-detail .item.next").removeClass("next"),orderSystem.datas.detialIndex>=n.model.collection.length)return orderSystem.alert("max"),!1;n.sliderItem(orderSystem.datas.detialIndex+1,"next")})},swipeRight:function(){var n=this;orderSystem.datas.haSwipe=!0;$(".din-item-detail .wrap").addClass("animate").css({"-webkit-transform":"translate3d(100%, 0, 0)"}).one("webkitTransitionEnd",function(){if(--orderSystem.datas.detialIndex,$(".din-item-detail .item.next").remove(),$(".din-item-detail .item").not(".prev").addClass("next"),$(".din-item-detail .item.prev").removeClass("prev"),orderSystem.datas.detialIndex<=0)return orderSystem.alert("mix"),!1;n.sliderItem(orderSystem.datas.detialIndex-1,"prev")})},setslider:function(n){var i=this.model.collection.length-1,t,r,u;if(n==0&&n!=i)t=new orderSystem.View.dinDetail({model:this.model.collection.models[n+1]}),t.$el.addClass("next");else if(n!=0&&n==i)t=new orderSystem.View.dinDetail({model:this.model.collection.models[n-1]}),t.$el.addClass("prev");else if(n!=0&&n!=i)r=new orderSystem.View.dinDetail({model:this.model.collection.models[n-1]}),r.$el.addClass("prev"),u=new orderSystem.View.dinDetail({model:this.model.collection.models[n+1]}),u.$el.addClass("next");else return!1},sliderItem:function(n,t){var i=new orderSystem.View.dinDetail({model:this.model.collection.models[n],attributes:{"class":"item "+t}})}});orderSystem.View.orderCatItem=Backbone.View.extend({tagName:"dl",events:{},initialize:function(){return _.bindAll(this,"goToDInList"),this.template=_.template($("#template-order-cat").html()),this},goToDInList:function(n){n.stopPropagation();orderSystem.datas.dinCatId="t_"+this.model.attributes.id;orderSystem.pages.menu(function(){$("#menu .page-back").hide();$("#order").remove()})}});orderSystem.View.orderCatList=Backbone.View.extend({el:".os-order-content",initialize:function(){var n=this;console.log();_.bindAll(this,"render","renderItem");this.template=_.template($("#template-order-cat").html());orderSystem.datas.order.teaList.each(function(n){var t=new orderSystem.View.orderItem({model:n});$("#order-tea-list ol").append(t.$el.wrapInner(t.template(t.model.toJSON())))});this.$el.find(".add").on("tap",this.goToDInList);return this},render:function(){for(var n=0;n<this.collection.models.length;n++)this.renderItem(this.collection.models[n]);return this},renderItem:function(n){var t=new orderSystem.View.orderCatItem({model:n}),i;this.$el.append(t.$el.wrapInner(this.template(t.model.toJSON())));t.$el.find(".add").on("tap",t.goToDInList);i=t.model.attributes.id;orderSystem.datas.order.dinList.each(function(n){if(n.attributes.typeId==i){var r=new orderSystem.View.orderItem({model:n});t.$el.find("ol").append(r.$el.wrapInner(r.template(r.model.toJSON())));r.$el.find(".number").html(r.$el.index()+1)}})}});orderSystem.View.orderItem=Backbone.View.extend({tagName:"li",events:{"tap .add":"dinAdd","tap .minus":"dinMinus","change select":"selectNum","tap .submit-item":"submitItem","tap .cancel-order":"cancelOrder","tap .cancel-item":"cancelItem","tap .superaddition":"superaddition"},initialize:function(){_.bindAll(this,"dinAdd","updataUI","updataStateUI","submitItem","cancelItem","superaddition","submitSuccess","submitError","cancelOrder","cancelError","cancelSuccess");this.template=_.template($("#template-order-item").html());this.model.on("change:ordNum",this.updataUI);this.model.on("change:state",this.updataStateUI);return this},dinAdd:function(){var n=this.model.attributes.ordNum+1;this.model.set({ordNum:n})},superaddition:function(){var n=this,t="",i,r;i=orderSystem.datas.order.perNum<10?11:parseInt(orderSystem.datas.order.perNum,10)+1;_.each(_.range(0,i),function(n){t+="<option>"+n+"<\/option>"});r="请选择要添加的数量：<select>"+t+"<\/select>";orderSystem.confirm(r,{title:"添加 "+n.model.attributes.dishName,okCallback:function(){var r=parseInt(this.$html.find("select").val(),10),i,u,f,e,t;r!=0&&(i=orderSystem.datas.order.dinList.findWhere({state:1,dishId:n.model.attributes.dishId}),typeof i!="undefined"?i.set({ordNum:parseInt(i.attributes.ordNum,10)+r}):(u=i=orderSystem.datas.dinListLoaded.findWhere({dishId:n.model.attributes.dishId}),typeof u!="undefined"?(u.set({state:1,stateName:"未下单",ordNum:r}),orderSystem.datas.order.dinList.add(u),t=new orderSystem.View.orderItem({model:u}),n.$el.parent().append(t.$el.wrapInner(t.template(t.model.toJSON()))),iscroll.orderList[$(".order-list-wrap").index(n.$el.parents(".order-list-wrap"))].refresh(),t.$el.addClass("t").css({"-webkit-transition-delay":"0.1s",opacity:"1"})):(f=new orderSystem.Model.dinList(n.model.toJSON()),f.set({ordNum:r,temporary:!0}),e=i=orderSystem.datas.order.dinList.at(orderSystem.datas.order.dinList.length-1),t=new orderSystem.View.orderItem({model:f}),n.$el.parent().append(t.$el.wrapInner(t.template(t.model.toJSON()))),iscroll.orderList[$(".order-list-wrap").index(n.$el.parents(".order-list-wrap"))].refresh(),t.$el.addClass("t").css({"-webkit-transition-delay":"0.1s",opacity:"1"}))),t.$el.find(".number").html(t.$el.index()+1),orderSystem.alert("成功添加  "+r+i.attributes.saleUnitName+" "+i.attributes.dishName),orderSystem.datas.order.dinList&&orderSystem.datas.order.dinList.add())}})},dinMinus:function(){var n=this,t=this.model.attributes.ordNum-1;t==0?orderSystem.confirm(n.model.attributes.dishName+" 数量为0，菜品将从订单中移除",{okCallback:function(){n.$el.css({opacity:0}).one("webkitTransitionEnd",function(){n.model.set({ordNum:0});orderSystem.datas.order.dinList.remove(n.model);n.$el.remove()})}}):this.model.set({ordNum:t})},selectNum:function(){var n=parseInt(this.$el.find("select").val());this.model.set({ordNum:n});this.model.previous("ordNum")==0?this.$el.find(".food-wrap").addClass("in-order"):n==0&&this.$el.find(".food-wrap").removeClass("in-order")},updataUI:function(){var n,t,i;if($("#order").length==0)return!1;n=this.model.attributes.ordNum;t="";_.each(_.range(0,n>=11?n+1:11),function(i){t+=i==n?"<option selected>"+i+"<\/option>":"<option>"+i+"<\/option>"});this.$el.find("select").html(t);i=parsePrice(this.model.attributes.price*n);this.$el.find(".subtotal").html(i)},updataStateUI:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.find(".number").html(this.$el.index()+1)},submitItem:function(){var n=new orderSystem.Model.orderDin({ordId:orderSystem.datas.order.id,dishInfo:this.model.toJsonList()});n.save(null,{success:this.submitSuccess,error:this.submitError})},addItem:function(){},cancelItem:function(){var n=this,t=this.model.attributes.dishName;orderSystem.confirm('是否将 <span style="color:#000">'+t+"<\/span> 从订单中移除",{okCallback:function(){n.$el.css({opacity:0}).one("webkitTransitionEnd",function(){n.model.set({ordNum:0});orderSystem.datas.order.dinList.remove(n.model);var t=$(".order-list-wrap").index(n.$el.parents(".order-list-wrap")),i=n.$el.siblings();n.$el.remove();i.each(function(n){$(this).find(".number").html(n+1)});iscroll.orderList[t].refresh()})}})},submitError:function(){orderSystem.alert(" "+this.model.attributes.dishName+" 下单失败,请检测网络后再重试")},submitSuccess:function(n,t){var i,r;t.state=="1"&&(console.log(this),i=this,r=this.model=="undefined"?this:this.model,orderSystem.alert(" "+this.model.attributes.dishName+" 下单成功",{callback:function(){var n=r.attributes.ordNum,t=r.attributes.total;i.model.set({total:n,ordNum:0,state:"2",stateName:"已下单"});orderSystem.datas.order.dinList.add(r.toJSON());i.model.set({total:t+n,ordNum:0});orderSystem.datas.order.dinList.remove(r);i.model=orderSystem.datas.order.dinList.at(orderSystem.datas.order.dinList.length-1);i.model.on("change:state",i.updataStateUI)}}))},cancelOrder:function(){var n=this,t=this.model.attributes.dishName;orderSystem.confirm('是否对 <span style="color:#000">'+t+"<\/span> 进行退单操作",{okCallback:function(){var t=new orderSystem.Model.orderCancelDin({odId:n.model.attributes.dishId});t.save(null,{success:n.cancelSuccess,error:n.cancelError})}})},cancelSuccess:function(n,t){var i,r,u;t.state=="1"&&(this.model.set({state:"0",stateName:"已退单"}),i=orderSystem.datas.dinListLoaded.findWhere({dishId:this.model.attributes.dishId,typeId:this.model.attributes.typeId}),typeof i!="undefined"?i.set({total:i.attributes.total-this.model.attributes.total}):$("#menu").length&&(r=orderSystem.datas.order.dinList.calculate(),u=parsePrice(r.totalPrice),$("#din-count").html(r.totalNum),$("#din-price").html(u)),orderSystem.alert(" "+this.model.attributes.dishName+" 退单成功"))},cancelError:function(){orderSystem.alert(" "+this.model.attributes.dishName+" 退单失败,请检测网络后再重试")}});orderSystem.View.orderSubmit=Backbone.View.extend({el:"#submit-order-all",initialize:function(){_.bindAll(this,"submitDInOrder","submitSuccess","submitError");this.$el.on("tap",this.submitDInOrder)},submitDInOrder:function(){var n=JSON.parse(orderSystem.datas.order.dinList.toJsonList(["1"])),t;n.length!=0?(t=new orderSystem.Model.orderDin({ordId:orderSystem.datas.order.id,dishInfo:n}),t.save(null,{success:this.submitSuccess,error:this.submitError})):orderSystem.alert("没有需要提交的菜品")},submitSuccess:function(n,t){t.state=="1"&&(orderSystem.datas.order.dinList.clone().each(function(n){var t=n.attributes.ordNum,i;t!=0&&(i=n.attributes.total,n.set({total:t,ordNum:0,state:"2",stateName:"已下单"}),orderSystem.datas.order.dinList.add(n.toJSON()),n.set({total:i+t,ordNum:0}),orderSystem.datas.order.dinList.remove(n));console.log(orderSystem.datas.order.dinList)}),orderSystem.alert("下单成功"))},submitError:function(){orderSystem.alert("下单失败,请检测网络后再重试")}});
//# sourceMappingURL=os-View.min.js.map